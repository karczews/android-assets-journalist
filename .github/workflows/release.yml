name: Release

on:
  push:
    branches: [ main ]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version
        id: version
        uses: tomtom-international/commisery-action/bump@v4
        with:
          token: ${{ github.token }}
          create-release: false
          create-tag: false

      - name: Setup JDK
        if: steps.version.outputs.next-version != ''
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        if: steps.version.outputs.next-version != ''
        run: chmod +x gradlew

      - name: Publish to Gradle Plugin Portal
        if: steps.version.outputs.next-version != ''
        run: ./gradlew publishPlugins -Pversion=${{ steps.version.outputs.next-version }}
        env:
          GRADLE_PUBLISH_KEY: ${{ secrets.GRADLE_PUBLISH_KEY }}
          GRADLE_PUBLISH_SECRET: ${{ secrets.GRADLE_PUBLISH_SECRET }}

      - name: Create release
        if: steps.version.outputs.next-version != ''
        uses: tomtom-international/commisery-action/bump@v4
        with:
          token: ${{ github.token }}
          create-release: true
          create-tag: true

      - name: Report release status
        run: |
          if [ -n "${{ steps.version.outputs.next-version }}" ]; then
            echo "✅ New version created: ${{ steps.version.outputs.next-version }}"
          else
            echo "ℹ️ No new version created - no version bump needed"
          fi
