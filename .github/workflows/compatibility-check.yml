name: Compatibility Check

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Plugin version to test'
        required: true
        default: '3.0.0'
        type: string
      min_agp_version:
        description: 'Minimum AGP version to test (e.g., 8.0.0)'
        required: false
        default: '8.0.0'
        type: string
  workflow_call:
    inputs:
      version:
        description: 'Plugin version to test'
        required: true
        type: string
      min_agp_version:
        description: 'Minimum AGP version to test (e.g., 8.0.0)'
        required: false
        default: '8.0.0'
        type: string

jobs:
  setup:
    name: Fetch AGP Versions
    runs-on: ubuntu-latest
    outputs:
      agp_versions: ${{ steps.fetch_versions.outputs.versions }}
    steps:
      - name: Fetch AGP versions from Maven
        id: fetch_versions
        run: |
          # Fetch maven-metadata.xml from Google's Maven repository
          curl -s https://dl.google.com/dl/android/maven2/com/android/tools/build/gradle/maven-metadata.xml > /tmp/maven-metadata.xml
          
          # Extract all versions
          versions=$(cat /tmp/maven-metadata.xml | grep -oE '<version>[0-9]+\.[0-9]+\.[0-9]+</version>' | sed 's/<version>//;s/<\/version>//' | sort -V | uniq)
          
          # Filter versions >= min_agp_version
          min_version="${{ inputs.min_agp_version }}"
          filtered_versions=()
          
          for version in $versions; do
            if [ "$(printf '%s\n' "$min_version" "$version" | sort -V | head -n1)" = "$min_version" ]; then
              filtered_versions+=("$version")
            fi
          done
          
          # Convert to JSON array
          json_array=$(printf '%s\n' "${filtered_versions[@]}" | jq -R . | jq -s . | tr -d '\n')
          
          echo "Found AGP versions: $json_array"
          echo "versions=$json_array" >> $GITHUB_OUTPUT

      - name: Save AGP versions artifact
        run: |
          mkdir -p ${{ github.workspace }}/agp-versions
          echo '${{ steps.fetch_versions.outputs.versions }}' > ${{ github.workspace }}/agp-versions/versions.json
      
      - name: Upload AGP versions
        uses: actions/upload-artifact@v6
        with:
          name: agp-versions-list
          path: ${{ github.workspace }}/agp-versions/versions.json

  compatibility-test:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        agp-version: ${{ fromJson(needs.setup.outputs.agp_versions) }}

    name: AGP ${{ matrix.agp-version }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: "platforms;android-35 build-tools;35.0.0"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create result directory
        run: mkdir -p ${{ github.workspace }}/results

      - name: Build Playground
        id: build
        working-directory: ./playground
        run: ./gradlew clean build -PpluginVersion=${{ inputs.version }} -PagpVersion=${{ matrix.agp-version }}

      - name: Record Success
        if: always() && steps.build.outcome == 'success'
        run: echo "SUCCESS" > ${{ github.workspace }}/results/agp-${{ matrix.agp-version }}-result.txt

      - name: Record Failure
        if: always() && steps.build.outcome == 'failure'
        run: echo "FAILED" > ${{ github.workspace }}/results/agp-${{ matrix.agp-version }}-result.txt

      - name: Upload Result
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: agp-result-${{ matrix.agp-version }}
          path: ${{ github.workspace }}/results/agp-${{ matrix.agp-version }}-result.txt

  report:
    name: Compatibility Report
    runs-on: ubuntu-latest
    needs: [setup, compatibility-test]
    if: always()
    steps:
      - name: Create results directory
        run: mkdir -p ${{ github.workspace }}/results

      - name: Download AGP versions list
        uses: actions/download-artifact@v7
        with:
          name: agp-versions-list
          path: ${{ github.workspace }}/agp-versions

      - name: Download Results
        uses: actions/download-artifact@v7
        with:
          path: ${{ github.workspace }}/results
          pattern: agp-result-*
          merge-multiple: true

      - name: Debug - List files
        run: |
          echo "=== AGP versions file ==="
          cat ${{ github.workspace }}/agp-versions/versions.json || echo "Not found"
          echo ""
          echo "=== Results directory ==="
          ls -la ${{ github.workspace }}/results/ || echo "Directory not found"
          echo ""
          echo "=== Results files ==="
          find ${{ github.workspace }}/results -name "*.txt" 2>/dev/null | head -20 || echo "No txt files found"

      - name: Generate Report
        run: |
          REPORT_FILE="${{ github.workspace }}/compatibility-report.md"
          
          echo "# AGP Compatibility Report" > "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "| AGP Version | Status |" >> "$REPORT_FILE"
          echo "|-------------|--------|" >> "$REPORT_FILE"
          
          success_count=0
          fail_count=0
          
          # Load versions from artifact
          versions_file="${{ github.workspace }}/agp-versions/versions.json"
          if [ -f "$versions_file" ]; then
            echo "Using versions from artifact file"
            versions=$(cat "$versions_file" | jq -r '.[]')
          else
            echo "Versions file not found, extracting from artifact names"
            versions=$(ls ${{ github.workspace }}/results/ | grep -oE 'agp-[0-9]+\.[0-9]+\.[0-9]+-result\.txt' | sed 's/agp-//;s/-result\.txt//' | sort -V | uniq)
          fi
          
          if [ -z "$versions" ]; then
            echo "No versions found to report" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "**Error:** No test results found" >> "$REPORT_FILE"
            cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "Found versions:"
          echo "$versions"
          
          while IFS= read -r version; do
            [ -z "$version" ] && continue
            
            result_file="${{ github.workspace }}/results/agp-${version}-result.txt"
            
            if [ -f "$result_file" ]; then
              result=$(cat "$result_file")
              if [ "$result" == "SUCCESS" ]; then
                echo "| $version | ✅ Success |" >> "$REPORT_FILE"
                success_count=$((success_count + 1))
              else
                echo "| $version | ❌ Failed |" >> "$REPORT_FILE"
                fail_count=$((fail_count + 1))
              fi
            else
              echo "| $version | ⚠️ No result |" >> "$REPORT_FILE"
              fail_count=$((fail_count + 1))
            fi
          done <<< "$versions"
          
          echo "" >> "$REPORT_FILE"
          echo "**Summary:** $success_count passed, $fail_count failed" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**Tested plugin version:** ${{ inputs.version }}" >> "$REPORT_FILE"
          
          # Also output to step summary
          cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Report
        uses: actions/upload-artifact@v6
        with:
          name: compatibility-report
          path: ${{ github.workspace }}/compatibility-report.md
