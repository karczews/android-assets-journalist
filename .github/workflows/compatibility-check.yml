name: Compatibility Check

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Plugin version to test'
        required: true
        default: '1.0.0-SNAPSHOT'
        type: string
      min_agp_version:
        description: 'Minimum AGP version to test (e.g., 8.0.0)'
        required: false
        default: '8.0.0'
        type: string

jobs:
  setup:
    name: Fetch AGP Versions
    runs-on: ubuntu-latest
    outputs:
      agp_versions: ${{ steps.fetch_versions.outputs.versions }}
    steps:
      - name: Fetch AGP versions from Maven
        id: fetch_versions
        run: |
          # Fetch maven-metadata.xml from Google's Maven repository
          curl -s https://dl.google.com/dl/android/maven2/com/android/tools/build/gradle/maven-metadata.xml > /tmp/maven-metadata.xml
          
          # Extract all versions (8.x.x and 9.x.x)
          versions=$(cat /tmp/maven-metadata.xml | grep -oE '<version>(8|9)\.[0-9]+\.[0-9]+</version>' | sed 's/<version>//;s/<\/version>//' | sort -V | uniq)
          
          # Filter versions >= min_agp_version
          min_version="${{ inputs.min_agp_version }}"
          filtered_versions=()
          
          for version in $versions; do
            if [ "$(printf '%s\n' "$min_version" "$version" | sort -V | head -n1)" = "$min_version" ]; then
              filtered_versions+=("$version")
            fi
          done
          
          # Convert to JSON array
          json_array=$(printf '%s\n' "${filtered_versions[@]}" | jq -R . | jq -s . | tr -d '\n')
          
          echo "Found AGP versions: $json_array"
          echo "versions=$json_array" >> $GITHUB_OUTPUT

  compatibility-test:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        agp-version: ${{ fromJson(needs.setup.outputs.agp_versions) }}

    name: AGP ${{ matrix.agp-version }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: "platforms;android-35 build-tools;35.0.0"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build and publish plugin
        run: ./gradlew clean build publishToMavenLocal -Pversion=${{ inputs.version }}

      - name: Build Playground
        run: |
          chmod +x .scripts/build_playground.sh
          ./.scripts/build_playground.sh ${{ inputs.version }} ${{ matrix.agp-version }}

      - name: Record Success
        if: success()
        run: echo "SUCCESS" > /tmp/agp-${{ matrix.agp-version }}-result.txt

      - name: Record Failure
        if: failure()
        run: echo "FAILED" > /tmp/agp-${{ matrix.agp-version }}-result.txt

      - name: Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agp-result-${{ matrix.agp-version }}
          path: /tmp/agp-${{ matrix.agp-version }}-result.txt

  report:
    name: Compatibility Report
    runs-on: ubuntu-latest
    needs: [setup, compatibility-test]
    if: always()
    steps:
      - name: Download Results
        uses: actions/download-artifact@v4
        with:
          path: /tmp/results
          pattern: agp-result-*
          merge-multiple: true

      - name: Generate Report
        run: |
          echo "# AGP Compatibility Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| AGP Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          success_count=0
          fail_count=0
          
          versions=$(echo '${{ needs.setup.outputs.agp_versions }}' | jq -r '.[]')
          
          for version in $versions; do
            result_file="/tmp/results/agp-${version}-result.txt"
            
            if [ -f "$result_file" ]; then
              result=$(cat "$result_file")
              if [ "$result" == "SUCCESS" ]; then
                echo "| $version | ✅ Success |" >> $GITHUB_STEP_SUMMARY
                ((success_count++))
              else
                echo "| $version | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
                ((fail_count++))
              fi
            else
              echo "| $version | ⚠️ No result |" >> $GITHUB_STEP_SUMMARY
              ((fail_count++))
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** $success_count passed, $fail_count failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tested plugin version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Minimum AGP version:** ${{ inputs.min_agp_version }}" >> $GITHUB_STEP_SUMMARY
